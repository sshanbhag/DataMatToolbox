%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
% FRAprocess.m
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------

%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% initial setup
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------

% clear all vars and close all plots to avoid confusion
% close all; 
% clear all;
FORCEFLAG = 0;




%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% file names
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------

%------------------------------------------------------------
% set path and library depending on system
%------------------------------------------------------------
switch computer
	case {'PCWIN', 'PCWIN64'}
		DLLName = 'C:\DataWave\DWShared\nsDWFile.dll';
		datapath = 'F:\Work\Data\DataWave\DDFtest';
	case 'MACI64'
		datapath = '/Users/sshanbhag/Work/Data/Bat/BatRestrainedData/FRAdata';
end

%------------------------------------------------------------
% information file
%------------------------------------------------------------
infofile = 'FRA_UnitInformation.csv';

% load information
fp = fopen(fullfile(datapath, infofile), 'r');
tmp = textscan(fgetl(fp), '%s', 'Delimiter', ',');
fieldnames = tmp{1};
nfields = length(fieldnames);
D = cell(1, nfields);
lIndex = 1;
while(~feof(fp))
	tmp = textscan(fgetl(fp), '%s', 'Delimiter', ',');
	tmpl = tmp{1}';
	% append empty cells if necessary
	if length(tmpl) < nfields
		tmpl = [tmpl cell(1, nfields - length(tmpl))];
	end
	D(lIndex, :) = tmpl;
	lIndex = lIndex + 1;
end
fclose(fp);
FRAinfo = cell2struct(D', fieldnames);
clear tmp tmpl lIndex

%------------------------------------------------------------
% datafiles
%------------------------------------------------------------
% freq/response area, sorted spikes (bat)
n = 1;
f = FRAinfo(n);
basename = [f.Animal '_' f.Date '--' f.Depth]
matfile = [basename '_FRA_Sorted.mat']

%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% convert DDF data to matfile (via NeuroShare) OR load matfile
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
if ~exist(fullfile(datapath, matfile), 'file') || FORCEFLAG
	fprintf('%s: converting ddf file to mat file...\n', mfilename)
	try
		D = DW.convertDDF2MAT(fullfile(datapath,filename), 'EVENT', 'SEGMENT', 'NEURAL');
	catch errMsg
		errMsg %#ok<NOPTS>
	end
	fprintf('%s: ....done\n', mfilename);
else
	fprintf('%s: loading .mat file %s\n', mfilename, fullfile(datapath, matfile));
	load(fullfile(datapath, matfile));
end

%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% create Data Object from DDF neuroshare data matfile
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
d = DW.FRAdata(D, fullfile(datapath, matfile));



%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% plot PSTH
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
S = d.getFRAspikes('probe', 1, 'unit', 255, 'window', [0 500]);


%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% plot FRA data
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
d.plotFRA(1, 255, [0 1000])

%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
%% save Data Object
%-----------------------------------------------------------------------------
%-----------------------------------------------------------------------------
save( fullfile(datapath, ['Dobj_' matfile]), 'd', 'D');

